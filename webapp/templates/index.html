<!DOCTYPE html>
<html>
<head>
    <title>Todos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 1rem; background-color: #fafafa; color: #333; }
        h1 { text-align: center; color: #333; }
        .todo-list { list-style: none; padding: 0; }
        .todo-item { background: white; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; align-items: flex-start; border: 1px solid #eee; }
        .todo-item.done .title { text-decoration: line-through; color: #999; }
        .checkbox { margin-right: 1rem; cursor: pointer; text-decoration: none; font-size: 1.4rem; line-height: 1; color: #3584e4; }
        .checkbox.unchecked { color: #ccc; }
        .content { flex-grow: 1; }
        .title { font-size: 1rem; line-height: 1.4; }
        .meta { font-size: 0.85rem; color: #666; margin-top: 0.3rem; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .tag { background: #f0f0f0; padding: 2px 8px; border-radius: 12px; color: #555; }
        .tag.project { color: #e66100; background: #fff1e5; }
        .tag.context { color: #1a5fb4; background: #eef5ff; }
        .due { color: #c01c28; font-weight: 500; }
        .add-form { display: flex; margin-bottom: 2rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 8px; }
        .add-form input { flex-grow: 1; padding: 0.8rem; border: 1px solid #ddd; border-right: none; border-radius: 8px 0 0 8px; font-size: 1rem; outline: none; }
        .add-form input:focus { border-color: #3584e4; }
        .add-form button { padding: 0.8rem 1.5rem; background: #3584e4; color: white; border: none; border-radius: 0 8px 8px 0; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .add-form button:hover { background: #1c71d8; }
        .section-header { margin-top: 2rem; margin-bottom: 1rem; font-size: 1.2rem; font-weight: 600; color: #333; padding-bottom: 0.5rem; border-bottom: 2px solid #eee; }
        
        .filter-link { text-decoration: none; color: #999; font-weight: normal; }
        .filter-link.active { color: #3584e4; font-weight: bold; }
        
        /* Mobile improvements */
        input { font-size: 16px; }
        button, .checkbox, .filter-link { touch-action: manipulation; }

        @media (prefers-color-scheme: dark) {
            body { background-color: #1e1e1e; color: #e0e0e0; }
            h1 { color: #e0e0e0; }
            .todo-item { background: #2d2d2d; border-color: #444; }
            .todo-item.done .title { color: #666; }
            .checkbox.unchecked { color: #555; }
            .meta { color: #aaa; }
            .tag { background: #3d3d3d; color: #ccc; }
            .tag.project { background: #4a2c1a; color: #ffb380; }
            .tag.context { background: #1a3b5c; color: #8cb4ff; }
            .due { color: #ff7b72; }
            .add-form input { background: #2d2d2d; border-color: #444; color: #e0e0e0; }
            .add-form button { background: #3584e4; }
            .section-header { color: #e0e0e0; border-bottom-color: #444; }
            .filter-link { color: #888; }
            .filter-link.active { color: #78aeed; }
            
            /* Modal Dark Mode */
            .modal-content { background-color: #2d2d2d; color: #e0e0e0; }
            .close { color: #aaa; }
            .close:hover, .close:focus { color: #fff; }
            .modal input[type="text"], .modal input[type="date"] { background: #3d3d3d; border-color: #555; color: #e0e0e0; }
            .btn-secondary { background: #3d3d3d; color: #e0e0e0; }
            .btn-action { background: #3d3d3d; border-color: #555; color: #e0e0e0; }
        }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .modal input[type="text"], .modal input[type="date"] { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .modal input[type="checkbox"] { transform: scale(1.5); margin-right: 0.5rem; }
        .buttons { display: flex; gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .btn-primary { background: #3584e4; color: white; padding: 0.8rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .btn-secondary { background: #e0e0e0; color: #333; padding: 0.8rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: bold; text-decoration: none; text-align: center; }
        .btn-action { background: #f6f5f4; border: 1px solid #ddd; color: #333; padding: 0.5rem; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block; line-height: 1; }
        .btn-action:hover { background: #e0e0e0; }
    </style>
</head>
<body>
    <!-- Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Edit Todo</h2>
            <form id="editForm" method="post">
                <div class="form-group">
                    <label for="edit-title">Title</label>
                    <input type="text" id="edit-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="edit-project">Project (+)</label>
                    <input type="text" id="edit-project" name="project">
                </div>
                <div class="form-group">
                    <label for="edit-context">Context (@)</label>
                    <input type="text" id="edit-context" name="context">
                </div>
                <div class="form-group">
                    <label for="edit-due">Due Date</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="date" id="edit-due" name="due">
                        <button type="button" class="btn-action" onclick="setModalDate(0)" title="Today">üìÖ</button>
                        <button type="button" class="btn-action" onclick="setModalDate(1)" title="Tomorrow">‚û°Ô∏è</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="edit-reference">Reference ([[ ]])</label>
                    <input type="text" id="edit-reference" name="reference">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="edit-done" name="done">
                        Done
                    </label>
                </div>
                
                <div class="buttons">
                    <button type="submit" class="btn-primary">Save</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <h1>Todos</h1>
    
    <div class="filters" style="margin-bottom: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <a href="{{ url_for('index', show_done=0 if show_done else 1, show_due_only=1 if show_due_only else 0, sort_mode=sort_mode) }}" 
           class="filter-link {% if show_done %}active{% endif %}">
           {% if show_done %}‚òë Show Done{% else %}‚òê Show Done{% endif %}
        </a>
        
        <a href="{{ url_for('index', show_done=1 if show_done else 0, show_due_only=0 if show_due_only else 1, sort_mode=sort_mode) }}"
           class="filter-link {% if show_due_only %}active{% endif %}">
           {% if show_due_only %}‚òë Hide Future{% else %}‚òê Hide Future{% endif %}
        </a>

        <span style="color: #ccc;">|</span>

        <a href="{{ url_for('index', show_done=1 if show_done else 0, show_due_only=1 if show_due_only else 0, sort_mode='topic') }}"
           class="filter-link {% if sort_mode == 'topic' %}active{% endif %}">
           Topic
        </a>
        <a href="{{ url_for('index', show_done=1 if show_done else 0, show_due_only=1 if show_due_only else 0, sort_mode='location') }}"
           class="filter-link {% if sort_mode == 'location' %}active{% endif %}">
           Location
        </a>
        <a href="{{ url_for('index', show_done=1 if show_done else 0, show_due_only=1 if show_due_only else 0, sort_mode='date') }}"
           class="filter-link {% if sort_mode == 'date' %}active{% endif %}">
           Date
        </a>
    </div>
    
    <form class="add-form" action="{{ url_for('add', show_done=1 if show_done else 0, show_due_only=1 if show_due_only else 0, sort_mode=sort_mode) }}" method="post">
        <input type="text" name="title" placeholder="New task..." required>
        <button type="submit">Add</button>
    </form>

    <div class="todo-list">
        {% set current_section = namespace(value=None) %}
        {% for todo in todos %}
            {% if todo.section != current_section.value %}
                <div class="section-header">{{ todo.section }}</div>
                {% set current_section.value = todo.section %}
            {% endif %}
            
            <div class="todo-item {% if todo.done %}done{% endif %}" onclick="openEditModal({{ todo.line_index }})" style="cursor: pointer;">
                <a href="{{ url_for('toggle', line_index=todo.line_index, show_done=1 if show_done else 0, show_due_only=1 if show_due_only else 0, sort_mode=sort_mode) }}" class="checkbox {% if not todo.done %}unchecked{% endif %}" onclick="event.stopPropagation()">
                    {% if todo.done %}‚òë{% else %}‚òê{% endif %}
                </a>
                <div class="content">
                    <div class="title">{{ todo.title }}</div>
                    <div class="meta">
                        {% if todo.project %}<span class="tag project">+{{ todo.project }}</span>{% endif %}
                        {% if todo.context %}<span class="tag context">@{{ todo.context }}</span>{% endif %}
                        {% if todo.due %}<span class="due">Due: {{ todo.due }}</span>{% endif %}
                    </div>
                </div>
                <div class="actions" style="margin-left: auto; display: flex; gap: 0.5rem;">
                    <a href="{{ url_for('postpone', line_index=todo.line_index, target='today') }}" class="btn-action" onclick="event.stopPropagation()" title="Today">üìÖ</a>
                    <a href="{{ url_for('postpone', line_index=todo.line_index, target='tomorrow') }}" class="btn-action" onclick="event.stopPropagation()" title="Tomorrow">‚û°Ô∏è</a>
                </div>
            </div>
        {% endfor %}
    </div>

    <div style="text-align: center; margin-top: 2rem; margin-bottom: 2rem;">
        <a href="{{ url_for('logout') }}" style="color: #999; text-decoration: none; padding: 1rem; display: inline-block;">Logout</a>
    </div>

    <script>
        var modal = document.getElementById("editModal");

        function openEditModal(lineIndex) {
            fetch('/api/todo/' + lineIndex)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error loading todo: ' + data.error);
                        return;
                    }
                    
                    document.getElementById('edit-title').value = data.title;
                    document.getElementById('edit-project').value = data.project || '';
                    document.getElementById('edit-context').value = data.context || '';
                    document.getElementById('edit-due').value = data.due || '';
                    document.getElementById('edit-reference').value = data.reference || '';
                    document.getElementById('edit-done').checked = data.done;
                    
                    document.getElementById('editForm').action = '/edit/' + lineIndex;
                    
                    modal.style.display = "block";
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load todo details');
                });
        }

        function closeModal() {
            modal.style.display = "none";
        }

        function setModalDate(offset) {
            const dateInput = document.getElementById('edit-due');
            const today = new Date();
            today.setDate(today.getDate() + offset);
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        function scheduleReload() {
            setTimeout(function() {
                var input = document.querySelector('input[name="title"]');
                if (document.activeElement === input || input.value.length > 0) {
                    scheduleReload();
                    return;
                }
                window.location.reload();
            }, 10000);
        }
        scheduleReload();
    </script>
</body>
</html>
